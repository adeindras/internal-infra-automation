- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: downstream
  id: d673a8bb-1605-4619-b9fd-6613d24b76ad
  loglevel: INFO
  maxMultipleExecutions: '100'
  multipleExecutions: true
  name: Terragrunt Executor Worker
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: 'tags: iam_terraform'
  nodesSelectedByDefault: true
  notification:
    onfailure:
      plugin:
        configuration:
          slack_channel: alerts-autorightsizing-failures-prod
          webhook_base_url: https://hooks.slack.com/services
          webhook_token: T3WDKH0L8/B075R3TMUUE/UMlb8CeYPjkJk5XJRVna0pXV
        type: SlackNotification
    onsuccess:
      plugin:
        configuration:
          slack_channel: alerts-autorightsizing-success-prod
          webhook_base_url: https://hooks.slack.com/services
          webhook_token: T3WDKH0L8/B076LGD90MN/mRPVt5L5WuVbpjLHm9zCU5gZ
        type: SlackNotification
  notifyAvgDurationThreshold: null
  options:
  - hidden: true
    label: AWS_ACCOUNT_ID
    name: AWS_ACCOUNT_ID
    required: true
    value: default
  - hidden: true
    label: BB_BRANCH_NAME
    name: BB_BRANCH_NAME
    required: true
    value: default
  - hidden: true
    label: BB_COMMIT_HASH
    name: BB_COMMIT_HASH
    required: true
    value: default
  - hidden: true
    label: BB_COMMIT_STATUS_ACCESS_TOKEN
    name: BB_COMMIT_STATUS_ACCESS_TOKEN
    required: true
    secure: true
    storagePath: keys/project/tier-up-down-prod/bitbucket_iac_repo_commit_status_token
    valueExposed: true
  - hidden: true
    label: BB_MODIFIED_FOLDER_NAME
    name: BB_MODIFIED_FOLDER_NAME
    required: true
    value: default
  - hidden: true
    label: BB_PULL_REQUEST_STATE
    name: BB_PULL_REQUEST_STATE
    required: true
    value: default
  - hidden: true
    label: ssh-private-key
    name: ssh-private-key
    required: true
    secure: true
    storagePath: keys/project/tier-up-down-prod/bitbucket_iac_repo_private_key_text
    valueExposed: true
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - script: |-
      #!/usr/bin/env bash
      # Copyright (c) 2017-2024 AccelByte Inc. All Rights Reserved.
      # This is licensed software from AccelByte Inc, for limitations
      # and restrictions contact your company contract manager.
      
      log() {
          local level="$1"
          local message="$2"
          local timestamp
          timestamp=$(date +"%Y-%m-%d %H:%M:%S")
          echo >&2 -e "${timestamp} [${level}] ${message}"
      }
      
      log_info() {
          local message="$1"
          log "INFO" "$message"
      }
      
      log_warn() {
          local message="$1"
          log "WARN" "$message"
      }
      
      log_error() {
          local message="$1"
          log "ERROR" "$message"
      }
      
      assert_is_installed() {
          local -r name="$1"
          if [[ ! $(command -v "${name}") ]]; then
              log_error "The binary '$name' is required by this script but is not installed or in the system's PATH."
              exit 1
          fi
      }
      
      generate_bitbucket_status_request_body() {
          local EXECUTION_ID="$1"
          local CURRENT_BUILD_DISPLAY_NAME="$2"
          local BB_STATE="$3"
          local EXEC_URL="$4"
          cat <<EOF
      {
          "key": "RUNDECK-EXECUTION-${EXECUTION_ID}",
          "name": "${CURRENT_BUILD_DISPLAY_NAME}",
          "state": "$BB_STATE",
          "description": "Rundeck Execution Pipeline",
          "url": "${EXEC_URL}"
      }
      EOF
      }
      
      update_bitbucket_status() {
          local BB_COMMIT_HASH="$1"
          local BB_STATE="$2"
          local BB_ACCESS_TOKEN="$3"
          local MODIFIED_FOLDER_NAME="$4"
      
          DIRECTORY_KIND=$(echo "${MODIFIED_FOLDER_NAME}" | awk -F'/' '{print $1}')
          EXECUTION_ID="@job.execid@"
      
          if [[ "${DIRECTORY_KIND}" == "account-bootstrap" ]]; then
              RESOURCE_NAME=$(echo "${MODIFIED_FOLDER_NAME}" | cut -d '/' -f3-)
              AWS_ACCOUNT_ID=$(echo "${MODIFIED_FOLDER_NAME}" | awk -F'/' '{print $2}')
              CURRENT_BUILD_DISPLAY_NAME="#${EXECUTION_ID} - ${RESOURCE_NAME} - ${AWS_ACCOUNT_ID}"
          else
              RESOURCE_NAME=$(echo "$MODIFIED_FOLDER_NAME" | cut -d '/' -f7-)
              CLIENT_NAME=$(echo "$MODIFIED_FOLDER_NAME" | awk -F'/' '{print $3}')
              PROJECT_NAME=$(echo "$MODIFIED_FOLDER_NAME" | awk -F'/' '{print $4}')
              ENVIRONMENT_NAME=$(echo "$MODIFIED_FOLDER_NAME" | awk -F'/' '{print $6}')
              CLUSTER_NAME="$CLIENT_NAME-$PROJECT_NAME-$ENVIRONMENT_NAME"
              CURRENT_BUILD_DISPLAY_NAME="#${EXECUTION_ID} - ${RESOURCE_NAME} - ${CLUSTER_NAME}"
          fi
      
          EXECUTION_URL="https://rundeck.prod.devportal.accelbyte.io/project/@job.project@/execution/show/$EXECUTION_ID#output"
      
          log_info "Sending build status to bitbucket"
          
          SEND_ATTEMPT=0
          SEND_ATTEMPT_THRESHOLD=3
          
          while true; do
              API_STATUS_CODE=$(curl -sXPOST "https://api.bitbucket.org/2.0/repositories/accelbyte/iac/commit/${BB_COMMIT_HASH}/statuses/build" \
                  -H "Authorization: Bearer ${BB_ACCESS_TOKEN}" \
                  -H "Content-Type: application/json" \
                  -o /dev/null \
                  -w "%{http_code}" \
                  --data \
                  "$(generate_bitbucket_status_request_body "$EXECUTION_ID" "$CURRENT_BUILD_DISPLAY_NAME" "$BB_STATE" "$EXECUTION_URL")")
      
              if [[ "${API_STATUS_CODE}" == "200" ]] || [[ "${API_STATUS_CODE}" == "201" ]]; then
                  log_info "Build status successfully sent to bitbucket"
                  break
              else
                  SEND_ATTEMPT=$(( SEND_ATTEMPT + 1 ))
                  if [[ "${SEND_ATTEMPT}" -ge "${SEND_ATTEMPT_THRESHOLD}" ]]; then
                      log_error "Unable to send build status to bitbucket after ${SEND_ATTEMPT_THRESHOLD} retry"
                      return 1
                  fi
      
                  log_error "Unable to send build status to bitbucket retrying in 5 seconds"
                  sleep 5
              fi
          done
      }
      
      cleanup() {
          DIRECTORY=$1
      
          if [[ ! -d "${DIRECTORY}" ]]; then
              log_error "Directory ${DIRECTORY} is not exist"
              log_error "The cleanup has been cancelled"
              return 1
          fi
      
          echo "hello world" > "${DIRECTORY}"/test.txt
      
          log_info "Begin to do directory cleanup.."
      
          CLEANUP_ATTEMPT=0
          CLEANUP_ATTEMPT_THRESHOLD=3
          
          while true; do
              rm -rf "${REPO_DIR}"
      
              if [[ ! -d "${DIRECTORY}" ]] && [[ ! -f "${DIRECTORY}"/test.txt ]]; then
                  log_info "${DIRECTORY} directory successfully cleaned up"
                  break
              else
                  CLEANUP_ATTEMPT=$(( CLEANUP_ATTEMPT + 1 ))
                  if [[ "${CLEANUP_ATTEMPT}" -ge "${CLEANUP_ATTEMPT_THRESHOLD}" ]]; then
                      log_error "Unable to do cleanup on ${DIRECTORY} directory after ${CLEANUP_ATTEMPT_THRESHOLD} retry"
                      return 1
                  fi
      
                  log_error "Unable to do cleanup on ${DIRECTORY} directory retrying in 10 seconds"
                  sleep 10
              fi
          done
          
          ls "${DIRECTORY}"
      }
      
      main() {
          assert_is_installed "jq"
          assert_is_installed "awk"
      
          AWS_ACCOUNT_ID="@option.AWS_ACCOUNT_ID@"
          BB_BRANCH_NAME="@option.BB_BRANCH_NAME@"
          BB_COMMIT_HASH="@option.BB_COMMIT_HASH@"
          BB_PULL_REQUEST_STATE="@option.BB_PULL_REQUEST_STATE@"
          BB_MODIFIED_FOLDER_NAME="@option.BB_MODIFIED_FOLDER_NAME@"
          BB_COMMIT_STATUS_ACCESS_TOKEN="@option.BB_COMMIT_STATUS_ACCESS_TOKEN@"
      
          # input validation
          if [[ "${AWS_ACCOUNT_ID}" == "default" ]]; then
              log_error "AWS_ACCOUNT_ID is empty"
              return 1
          fi
      
          if [[ "${BB_BRANCH_NAME}" == "default" ]]; then
              log_error "BB_BRANCH_NAME is empty"
              return 1
          fi
      
          BB_PULL_REQUEST_IDENTIFIER="autorightsizing"
          BB_BRANCH_IDENTIFIER=$(echo "${BB_BRANCH_NAME}" | awk -F'-' '{print $1}')
      
          if [[ "${BB_BRANCH_IDENTIFIER}" != "${BB_PULL_REQUEST_IDENTIFIER}" ]]; then
              log_info "Branch Name : ${BB_PULL_REQUEST_BRANCH_NAME}"
              log_info "Not a rightsizing event, skipping..."
              return 0
          fi
      
          if [[ "${BB_COMMIT_HASH}" == "default" ]]; then
              log_error "BB_COMMIT_HASH is empty"
              return 1
          fi
      
          if [[ "${BB_PULL_REQUEST_STATE}" == "default" ]]; then
              log_error "BB_PULL_REQUEST_STATE is empty"
              return 1
          fi
      
          if [[ "${BB_MODIFIED_FOLDER_NAME}" == "default" ]]; then
              log_error "BB_MODIFIED_FOLDER_NAME is empty"
              return 1
          fi
      
          if [[ -z "${BB_COMMIT_STATUS_ACCESS_TOKEN}" ]]; then
              log_error "Commit status token is empty"
              return 1
          fi
      
          # key validation
          UNIQUE_STRING="@job.execid@"
          # UNIQUE_STRING=$(uuidgen v4 | tr -d "-")
          REPO_DIR="/tmp/tmp.${UNIQUE_STRING}"
          mkdir -p "${REPO_DIR}/etc"
      
          TEMP_KEY="${REPO_DIR}/etc/temp.key"
          echo "@option.ssh-private-key@" >"${TEMP_KEY}"
          IS_KEY_EXIST=$(
              grep "BEGIN" "${TEMP_KEY}" >/dev/null
              echo $?
          )
          if [[ "${IS_KEY_EXIST}" -gt "0" ]]; then
              log_error "Key is invalid" &&
                  update_bitbucket_status "${BB_COMMIT_HASH}" "FAILED" "${BB_COMMIT_STATUS_ACCESS_TOKEN}" "${BB_MODIFIED_FOLDER_NAME}"
              return 1
          fi
      
          sed -i -e 's/ /\n/g' "${TEMP_KEY}"
          sed -i -z "s/END\n/END /g;s/SSH\n/SSH /g;s/VATE\n/VATE /g;s/BEGIN\n/BEGIN /g" "${TEMP_KEY}"
      
          chmod 400 "${TEMP_KEY}"
      
          cd "${REPO_DIR}"
      
          GIT_SSH_COMMAND="ssh -i ${TEMP_KEY} -o IdentitiesOnly=yes -o StrictHostKeyChecking=no" \
              git clone git@bitbucket.org:accelbyte/iac.git
      
          cd iac
      
          CURRENT_DIR=$(pwd)
      
          ls -ltrah "${REPO_DIR}"
      
          if [[ "${BB_PULL_REQUEST_STATE}" == "MERGED" ]]; then
              cd "${CURRENT_DIR}/${BB_MODIFIED_FOLDER_NAME}"
              
              log_info "${PWD}"
              log_info "TODO: terragrunt apply"
              terragrunt apply --auto-approve && export TG_COMMAND_ERROR="0"
              # export TG_COMMAND_ERROR="0"
          else
              git checkout "${BB_BRANCH_NAME}"
      
              cd "${CURRENT_DIR}/${BB_MODIFIED_FOLDER_NAME}"
      
              log_info "${PWD}"
              log_info "TODO: terragrunt plan"
              terragrunt plan && export TG_COMMAND_ERROR="0"
              # export TG_COMMAND_ERROR="0"
          fi
      
          cleanup "${REPO_DIR}"
      
          if [[ "${TG_COMMAND_ERROR}" != "0" ]]; then
              log_error "Something went wrong during pipeline execution"
              #update_bitbucket_status "${BB_COMMIT_HASH}" "FAILED" "${BB_COMMIT_STATUS_ACCESS_TOKEN}" "${BB_MODIFIED_FOLDER_NAME}"
              return 1
          else
              update_bitbucket_status "${BB_COMMIT_HASH}" "SUCCESSFUL" "${BB_COMMIT_STATUS_ACCESS_TOKEN}" "${BB_MODIFIED_FOLDER_NAME}"
          fi
      }
      
      main "$@"
    keepgoing: false
    strategy: node-first
  uuid: d673a8bb-1605-4619-b9fd-6613d24b76ad
